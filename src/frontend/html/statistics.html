<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" crossorigin="use-credentials" href="/manifest" />

  <title>üìà Statistics</title>

  <style>
    *, *::before, *::after { box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e1e2f, #2b2b45);
      color: #fff;
      margin: 0;
      padding: 1rem;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }

    main.card {
      background-color: #2e2e48;
      padding: 1rem;
      border-radius: 1rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      max-width: 420px;
      width: 100%;
      display: flex;
      flex-direction: column;
    }

    h1 {
      margin-bottom: 1rem;
      font-size: 1.4rem;
      color: #ffd700;
      text-align: center;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.75rem;
      font-size: 0.9rem;
      margin-bottom: 1.5rem;
    }

    .stat {
      background-color: #3a3a5c;
      padding: 0.6rem 0.8rem;
      border-radius: 0.5rem;
      text-align: left;
      line-height: 1.2;
      color: #fff;
    }

    .stat strong {
      display: block;
      color: #ffd700;
      font-weight: 600;
      font-size: 0.85rem;
      margin-bottom: 0.2rem;
    }

    .chart-container {
      display: flex;
      flex-direction: column;
      gap: 1.4rem;
    }

    canvas {
      width: 100% !important;
      height: auto !important;
      max-height: 220px;
      border-radius: 0.8rem;
      background-color: #1e1e2f;
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2);
    }

    .back-button {
      display: inline-block;
      margin-bottom: 1rem;
      font-size: 1rem;
      color: #ffd700;
      text-decoration: none;
      font-weight: bold;
    }

    .back-button:hover {
      color: #ffcc00;
    }
  </style>
</head>
<body>
  <main class="card" role="main" aria-label="Statistics Overview">
    <a href="/" class="back-button">‚Üê Back</a>
    <h1>üìà Statistics</h1>

    <div class="stats-grid">
      <div class="stat"><strong>Total Balance</strong>{{ total_balance }} kr</div>
      <div class="stat"><strong>Total Deposit</strong>{{ total_deposit }} kr</div>
      <div class="stat"><strong>Total Money</strong>{{ total_money }} kr</div>
      <div class="stat"><strong>Total Oddset Balance</strong>{{ total_oddset_balance }} kr</div>      
      <div class="stat"><strong>Travel Date</strong>{{ expected_travel_date }}</div>
    </div>

    <div class="chart-container">
      <canvas id="totalBalanceChart"></canvas>
      <canvas id="freebetsChart"></canvas>
      <canvas id="totalWonChart"></canvas>
      <canvas id="winRateChart"></canvas>
      <canvas id="depositChart"></canvas>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

  <script>
    const players = {{ player_stats_list | json_encode() | safe }};
    const names = players.map(p => p.username);
    const colors = players.map(p => p.color);

    function percentile(arr, p) {
      if (arr.length === 0) return 0;
      const sorted = arr.slice().sort((a, b) => a - b);
      const index = (sorted.length - 1) * p;
      const lower = Math.floor(index);
      const upper = Math.ceil(index);
      if (lower === upper) return sorted[lower];
      const weight = index - lower;
      return sorted[lower] * (1 - weight) + sorted[upper] * weight;
    }

function makeChart(id, label, field, type='bar', suffix='') {
  const ctx = document.getElementById(id).getContext('2d');
  const dataValues = players.map(p => p[field]);
  const barColors = players.map(p => p.color);

  const p10 = percentile(dataValues, 0.1);
  const p90 = percentile(dataValues, 0.9);

  let range = p90 - p10;
  let yMin = p10 - range * 0.1;
  let yMax = p90 + range * 0.1;

  if (range < 0.5) {
    const median = percentile(dataValues, 0.5);
    yMin = median - 0.5;
    yMax = median + 0.5;
  }
  if (range === 0) {
    yMin = dataValues[0] - 1;
    yMax = dataValues[0] + 1;
  }
  if (range >= 0.5 && range < 5) {
    const mid = (p10 + p90) / 2;
    yMin = mid - range;
    yMax = mid + range;
  }

  new Chart(ctx, {
    type: type,
    data: {
      labels: names,
      datasets: [{
        label: label,
        data: dataValues,
        backgroundColor: barColors,
        borderRadius: 6,
        borderSkipped: false,
      }]
    },
    options: {
      responsive: true,
      layout: { padding: 10 },
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: label,
          color: '#fff',         // white text
          font: { size: 14, weight: 'bold' }
        },
        tooltip: {
          callbacks: {
            label: ctx => ctx.parsed.y + suffix
          },
          bodyColor: '#fff',      // tooltip text white
          backgroundColor: 'rgba(0,0,0,0.7)'
        },
       datalabels: {
  anchor: 'center',
  align: 'center',
  color: '#fff',
  font: { weight: 'bold', size: 12 },
  formatter: value => value + suffix,
  clamp: false,
  clip: false,
  backgroundColor: null,
  padding: 0,

  textShadowColor: 'rgba(0, 0, 0, 0.5)', // subtle black shadow
  textShadowBlur: 2,                      // small blur for shadow
},

      },
      scales: {
        y: {
          min: yMin,
          max: yMax,
          ticks: {
            color: '#fff',        // white text
            font: { size: 11 },
            maxTicksLimit: 5
          },
          grid: { color: 'rgba(255, 255, 255, 0.1)' }  // lighter white grid
        },
        x: {
          ticks: { color: '#fff', font: { size: 11 } }, // white text
          grid: { display: false }
        }
      }
    },
    plugins: [ChartDataLabels]
  });
}


    makeChart('totalBalanceChart', 'Total Balance (kr)', 'total_balance');
    makeChart('totalWonChart', 'Total Won (kr)', 'total_won');
    makeChart('winRateChart', 'Win Rate %', 'winrate', 'bar', '%');
    makeChart('depositChart', 'Deposit (kr)', 'total_deposit');
    makeChart('freebetsChart', 'amount of Free Bets', 'amount_of_freebets');
  </script>
</body>
</html>
